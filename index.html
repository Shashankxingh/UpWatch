<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UpWatch Enterprise</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<script>
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      fontFamily: {
        sans: ['Inter', 'sans-serif'],
        mono: ['JetBrains Mono', 'monospace'],
      },
      colors: {
        background: "#030712", // Deepest black/blue
        surface: "#111827",
        border: "#1f2937",
        accent: "#3b82f6",
        success: "#22c55e",
        warning: "#eab308",
        danger: "#ef4444",
      },
      animation: {
        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
      }
    }
  }
}
</script>

<style>
  body { background-color: #030712; color: #e5e7eb; -webkit-font-smoothing: antialiased; }
  
  /* Utility Classes */
  .panel {
    background: linear-gradient(145deg, #111827, #0f172a);
    border: 1px solid #1f2937;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
  }
  
  .status-dot { box-shadow: 0 0 10px currentColor; }
  
  /* Custom Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: #030712; }
  ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }

  .input-focus:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 1px #3b82f6, 0 0 0 4px rgba(59, 130, 246, 0.1);
  }
</style>
</head>

<body class="h-screen flex overflow-hidden selection:bg-accent selection:text-white">

<aside class="w-64 border-r border-border bg-[#050b1a] flex flex-col hidden md:flex">
  <div class="p-6 flex items-center gap-3">
    <div class="w-8 h-8 bg-accent rounded-lg flex items-center justify-center text-white font-bold">U</div>
    <span class="font-bold text-lg tracking-tight">UpWatch_</span>
  </div>

  <nav class="flex-1 px-4 space-y-1">
    <a href="#" class="flex items-center gap-3 px-3 py-2 text-sm font-medium bg-accent/10 text-accent rounded-md">
      <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard
    </a>
    <a href="#" class="flex items-center gap-3 px-3 py-2 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 rounded-md transition">
      <i data-lucide="activity" class="w-4 h-4"></i> Incidents
    </a>
  </nav>

  <div class="p-4 border-t border-border">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500"></div>
      <div>
        <div class="text-sm font-medium text-white">Admin User</div>
        <div class="text-xs text-gray-500">Pro Plan</div>
      </div>
    </div>
  </div>
</aside>

<main class="flex-1 flex flex-col h-full relative overflow-hidden">
  
  <header class="h-16 border-b border-border flex items-center justify-between px-8 bg-[#030712]/80 backdrop-blur-md z-10">
    <div class="flex items-center gap-4">
      <h1 class="font-semibold text-white">Overview</h1>
      <span class="h-4 w-px bg-border"></span>
      <div id="global-status" class="flex items-center gap-2 text-xs font-medium px-2 py-1 rounded-full bg-gray-800 text-gray-400 border border-gray-700">
        Initializing...
      </div>
    </div>
    
    <button onclick="document.getElementById('addModal').classList.remove('hidden')" 
            class="bg-white text-black hover:bg-gray-200 px-4 py-1.5 rounded-md text-sm font-medium transition flex items-center gap-2">
      <i data-lucide="plus" class="w-4 h-4"></i> Add Monitor
    </button>
  </header>

  <div class="flex-1 overflow-y-auto p-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="panel rounded-xl p-5 relative overflow-hidden group">
        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110">
           <i data-lucide="globe" class="w-16 h-16 text-white"></i>
        </div>
        <div class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">Total Monitors</div>
        <div class="text-3xl font-bold text-white" id="stat-total">0</div>
      </div>
      
      <div class="panel rounded-xl p-5 relative overflow-hidden">
        <div class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">Avg. Uptime</div>
        <div class="text-3xl font-bold text-white flex items-end gap-2">
          <span id="stat-uptime">--%</span>
        </div>
      </div>

      <div class="panel rounded-xl p-5 relative overflow-hidden">
        <div class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">Active Incidents</div>
        <div class="text-3xl font-bold text-white" id="stat-incidents">0</div>
      </div>
    </div>

    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-white">Active Monitors</h2>
    </div>

    <div id="grid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
      </div>
  </div>
</main>

<div id="addModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
  <div class="panel w-full max-w-md rounded-xl p-6 shadow-2xl border border-white/10 transform transition-all scale-100">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-lg font-semibold text-white">New Monitor</h3>
      <button onclick="document.getElementById('addModal').classList.add('hidden')" class="text-gray-400 hover:text-white">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="block text-xs font-medium text-gray-400 mb-1">Display Name</label>
        <input id="input-name" class="w-full bg-[#050b1a] border border-border rounded-lg px-4 py-2.5 text-white text-sm input-focus" placeholder="e.g. Production API">
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-400 mb-1">Endpoint URL</label>
        <div class="relative">
          <span class="absolute left-4 top-2.5 text-gray-500 text-sm">GET</span>
          <input id="input-url" class="w-full bg-[#050b1a] border border-border rounded-lg pl-14 pr-4 py-2.5 text-white text-sm input-focus" placeholder="https://api.example.com">
        </div>
      </div>
      <button id="btn-add" class="w-full bg-white hover:bg-gray-200 text-black font-semibold py-2.5 rounded-lg transition mt-2">
        Start Monitoring
      </button>
    </div>
  </div>
</div>

<script>
// UPDATED: Points to your live backend
const API = "https://upwatch.onrender.com";

lucide.createIcons();

// --- SVG SPARKLINE GENERATOR ---
function generateSparkline(data, width = 300, height = 50) {
  if (!data || data.length < 2) return "";
  const max = Math.max(...data, 100); 
  const min = 0;
  const range = max - min;
  const stepX = width / (data.length - 1);
  
  const pathPoints = data.map((val, i) => {
    const x = i * stepX;
    const y = height - ((val - min) / range) * height;
    return `${x},${y}`;
  });

  return `
    <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
      <defs>
        <linearGradient id="grad-${data[0]}" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:currentColor;stop-opacity:0.2" />
          <stop offset="100%" style="stop-color:currentColor;stop-opacity:0" />
        </linearGradient>
      </defs>
      <path d="M0,${height} L${pathPoints.join(' L')} L${width},${height} Z" fill="currentColor" fill-opacity="0.1" stroke="none" />
      <path d="M${pathPoints.join(' L')}" fill="none" stroke="currentColor" stroke-width="2" vector-effect="non-scaling-stroke" />
    </svg>
  `;
}

// Maps backend status (UP/DOWN) to Frontend Style (OPERATIONAL/DOWN)
function getStatusConfig(status) {
  const s = status.toUpperCase();
  if (s === 'UP' || s === 'OPERATIONAL') return { color: 'text-success', bg: 'bg-success', label: 'Operational' };
  if (s === 'DEGRADED') return { color: 'text-warning', bg: 'bg-warning', label: 'Degraded' };
  if (s === 'DOWN') return { color: 'text-danger', bg: 'bg-danger', label: 'System Down' };
  return { color: 'text-gray-400', bg: 'bg-gray-400', label: 'Pending' };
}

function renderCard(m) {
  const config = getStatusConfig(m.status);
  const lastLatency = m.latencyHistory && m.latencyHistory.length ? m.latencyHistory.at(-1) : 0;
  const sparklineSVG = generateSparkline(m.latencyHistory || []);

  return `
  <div class="panel rounded-xl p-5 transition hover:border-gray-500">
    <div class="flex justify-between items-start mb-4">
      <div>
        <div class="flex items-center gap-2 mb-1">
          <div class="w-2 h-2 rounded-full ${config.bg} status-dot animate-pulse"></div>
          <h3 class="font-semibold text-sm text-white">${m.name}</h3>
        </div>
        <a href="${m.url}" target="_blank" class="text-xs text-gray-500 hover:text-accent truncate max-w-[150px] block">${m.url}</a>
      </div>
      <div class="text-right">
        <div class="text-xs text-gray-400 font-mono">UPTIME</div>
        <div class="font-bold text-white ${parseFloat(m.uptime) < 99 ? 'text-warning' : ''}">${m.uptime}%</div>
      </div>
    </div>
    <div class="h-12 w-full mb-4 ${config.color}">
      ${sparklineSVG}
    </div>
    <div class="flex items-center justify-between pt-3 border-t border-white/5">
      <div class="flex items-center gap-2 text-xs text-gray-400">
        <i data-lucide="clock" class="w-3 h-3"></i>
        ${m.lastPing ? new Date(m.lastPing).toLocaleTimeString() : "Syncing..."}
      </div>
      <div class="text-sm font-mono font-medium ${lastLatency > 500 ? 'text-warning' : 'text-gray-300'}">
        ${lastLatency}ms
      </div>
    </div>
  </div>`;
}

async function load() {
  try {
    const res = await fetch(API + "/api/monitors");
    const rawData = await res.json();
    
    // ADAPTER: Handle both Old Backend (Array) and New Backend (Object)
    let monitors = [];
    let stats = { total: 0, down: 0 };

    if (Array.isArray(rawData)) {
      monitors = rawData;
      stats.total = monitors.length;
      stats.down = monitors.filter(m => m.status === 'DOWN').length;
      // Calculate avg uptime manually for old backend
      const totalUptime = monitors.reduce((acc, m) => acc + parseFloat(m.uptime || 0), 0);
      stats.uptime = monitors.length ? (totalUptime / monitors.length).toFixed(2) : "0.00";
    } else {
      monitors = rawData.monitors;
      stats = rawData.stats;
      // If new backend doesn't send avg uptime, calculate it
      if(!stats.uptime) {
         const totalUptime = monitors.reduce((acc, m) => acc + parseFloat(m.uptime || 0), 0);
         stats.uptime = monitors.length ? (totalUptime / monitors.length).toFixed(2) : "0.00";
      }
    }

    // Update Widgets
    document.getElementById('stat-total').innerText = stats.total;
    document.getElementById('stat-incidents').innerText = stats.down;
    document.getElementById('stat-uptime').innerText = stats.uptime + "%";
    
    // Update Header Status
    const globalEl = document.getElementById('global-status');
    if (stats.down > 0) {
      globalEl.className = "flex items-center gap-2 text-xs font-medium px-2 py-1 rounded-full bg-danger/10 text-danger border border-danger/20";
      globalEl.innerHTML = `<i data-lucide="alert-triangle" class="w-3 h-3"></i> ${stats.down} Systems Down`;
    } else {
      globalEl.className = "flex items-center gap-2 text-xs font-medium px-2 py-1 rounded-full bg-success/10 text-success border border-success/20";
      globalEl.innerHTML = `<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-success opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-success"></span></span> All Systems Operational`;
    }

    // Render Grid
    const grid = document.getElementById("grid");
    grid.innerHTML = monitors.length 
      ? monitors.map(renderCard).join("") 
      : `<div class="col-span-full py-12 text-center text-gray-500 border border-dashed border-white/10 rounded-xl">
           <i data-lucide="server" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
           <p>No monitors active. Add one to start.</p>
         </div>`;
         
    lucide.createIcons();
    
  } catch (e) {
    console.error("Sync failed", e);
  }
}

document.getElementById('btn-add').onclick = async () => {
  const name = document.getElementById('input-name').value;
  const url = document.getElementById('input-url').value;
  const btn = document.getElementById('btn-add');

  if (!name || !url) return;

  btn.innerHTML = "Adding...";
  btn.disabled = true;

  try {
    await fetch(API + "/api/monitor", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, url })
    });
  } catch(e) {
    console.error(e);
    alert("Failed to add monitor. Check console.");
  }

  document.getElementById('addModal').classList.add('hidden');
  document.getElementById('input-name').value = "";
  document.getElementById('input-url').value = "";
  btn.innerHTML = "Start Monitoring";
  btn.disabled = false;
  
  load();
};

load();
setInterval(load, 2000); 
</script>

</body>
</html>
